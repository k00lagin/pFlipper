"use strict";(self["webpackChunkmy_flipper_net"]=self["webpackChunkmy_flipper_net"]||[]).push([[369],{8369:(e,t,s)=>{s.r(t),s.d(t,{default:()=>W});var i=s(9835),o=s(6970);const r={key:0,class:"column flex-center q-my-xl"},l=(0,i._)("p",{class:"text-white"},"Waiting for Flipper...",-1),a={key:1,class:"full-width",style:{height:"calc(100vh - 50px)"}},n=(0,i._)("div",{id:"terminal-container",class:"fit bg-black"},null,-1),c=(0,i._)("div",{class:"text-h6 q-mr-xl"},"CLI session sharing",-1),m=(0,i.Uk)(" Room name: "),g={class:"bg-grey-4 q-pa-xs rounded-borders"},h=(0,i._)("br",null,null,-1),p=["href"];function d(e,t,s,d,u,v){const f=(0,i.up)("q-spinner"),w=(0,i.up)("q-badge"),k=(0,i.up)("q-btn"),b=(0,i.up)("q-space"),C=(0,i.up)("q-card-section"),y=(0,i.up)("q-toggle"),A=(0,i.up)("q-card-actions"),q=(0,i.up)("q-card"),S=(0,i.up)("q-dialog"),_=(0,i.up)("q-page"),$=(0,i.Q2)("close-popup");return(0,i.wg)(),(0,i.j4)(_,{class:"column items-center bg-black q-pl-sm"},{default:(0,i.w5)((()=>[e.connected?(0,i.kq)("",!0):((0,i.wg)(),(0,i.iD)("div",r,[(0,i.Wm)(f,{color:"primary",size:"3em",class:"q-mb-md"}),l])),e.connected&&!e.flags.rpcActive?((0,i.wg)(),(0,i.iD)("div",a,[n,e.flags.sharingEnabled?((0,i.wg)(),(0,i.j4)(k,{key:0,onClick:t[0]||(t[0]=t=>e.flags.sharePopup=!0),outline:"",color:"white",class:"absolute-top-right q-ma-sm z-top shadow-2",style:{"margin-right":"25px"}},{default:(0,i.w5)((()=>[(0,i.Uk)((0,o.zw)(e.flags.serverActive?"Session live":"Share session")+" ",1),e.flags.serverActive?((0,i.wg)(),(0,i.j4)(w,{key:0,label:e.clientsCount>0?e.clientsCount:"",rounded:"",color:"green",class:"q-ml-md"},null,8,["label"])):(0,i.kq)("",!0)])),_:1})):(0,i.kq)("",!0)])):(0,i.kq)("",!0),(0,i.Wm)(S,{modelValue:e.flags.sharePopup,"onUpdate:modelValue":t[3]||(t[3]=t=>e.flags.sharePopup=t)},{default:(0,i.w5)((()=>[(0,i.Wm)(q,null,{default:(0,i.w5)((()=>[(0,i.Wm)(C,{class:"row items-center q-pb-none"},{default:(0,i.w5)((()=>[c,(0,i.Wm)(b),(0,i.wy)((0,i.Wm)(k,{icon:"close",flat:"",round:"",dense:""},null,512),[[$]])])),_:1}),(0,i.Wm)(C,null,{default:(0,i.w5)((()=>[e.flags.serverActive?((0,i.wg)(),(0,i.iD)(i.HY,{key:0},[(0,i._)("p",null,[m,(0,i._)("code",g,(0,o.zw)(e.roomName),1),h,(0,i._)("a",{href:"/remote-cli#"+e.roomName,target:"_blank"},"Sharelink",8,p)]),(0,i._)("p",null," Clients connected: "+(0,o.zw)(e.clientsCount),1),(0,i.Wm)(y,{modelValue:e.flags.allowPeerInput,"onUpdate:modelValue":t[1]||(t[1]=t=>e.flags.allowPeerInput=t),label:"Allow peer input"},null,8,["modelValue"])],64)):(0,i.kq)("",!0)])),_:1}),(0,i.Wm)(A,{align:"right"},{default:(0,i.w5)((()=>[(0,i.Wm)(k,{flat:"",loading:e.flags.serverToggling,color:e.flags.serverActive?"negative":"black",onClick:t[2]||(t[2]=t=>e.flags.serverActive?e.stopServer():e.startServer())},{default:(0,i.w5)((()=>[(0,i.Uk)((0,o.zw)(e.flags.serverActive?"Stop server":"Start server"),1)])),_:1},8,["loading","color"])])),_:1})])),_:1})])),_:1},8,["modelValue"])])),_:1})}s(8170),s(5231),s(9359),s(6408),s(8964),s(2809),s(702),s(3269);var u=s(499),v=s(6797),f=s(4880),w=s(6973);const k=(0,i.aZ)({name:"PageCli",props:{flipper:Object,info:Object,connected:Boolean,rpcActive:Boolean},setup(){return{flags:(0,u.iH)({rpcActive:!1,rpcToggling:!1,serverActive:!1,serverToggling:!1,sharePopup:!1,allowPeerInput:!1,sharingEnabled:!1}),terminal:(0,u.iH)(void 0),readInterval:void 0,input:(0,u.iH)(""),unbind:(0,u.iH)(void 0),socket:(0,u.iH)(null),roomName:(0,u.iH)(""),clientsCount:(0,u.iH)(0),clientsPollingInterval:(0,u.iH)(null)}},methods:{init(){this.terminal=new v.Terminal({scrollback:1e4});const e=new f.FitAddon;this.terminal.loadAddon(e),this.terminal.open(document.getElementById("terminal-container")),document.querySelector(".xterm").setAttribute("style","height:"+getComputedStyle(document.querySelector(".xterm")).height),this.terminal.focus(),e.fit(),this.write(""),this.read(),this.terminal.onData((async e=>{this.write(e)}))},write(e){this.flipper.write("cli",e)},read(){this.flipper.read("cli")},async stopRpc(){this.flags.rpcToggling=!0,await this.flipper.commands.stopRpcSession(),this.flags.rpcActive=!1,this.flags.rpcToggling=!1,this.$emit("setRpcStatus",!1),this.$emit("log",{level:"info",message:"CLI: RPC stopped"})},startServer(){this.flags.serverToggling=!0,this.roomName=this.info.hardware_name,this.socket||(this.socket=(0,w.io)("ws://my.flipp.dev:3000")),this.socket.on("connect",(()=>{this.$emit("log",{level:"info",message:`CLI: Connected to cli server. My id: ${this.socket.id}, room name: ${this.roomName}`}),this.socket.emit("claimRoomName",this.roomName,(e=>{e.error&&(this.$emit("showNotif",{message:`Failed to claim room ${this.roomName}`,color:"negative"}),this.$emit("log",{level:"error",message:`CLI: Failed to claim room ${this.roomName}: ${e.error.toString()}`}))})),this.socket.emit("joinRoom",this.roomName,(e=>{e.error?(this.$emit("showNotif",{message:`Failed to join room ${this.roomName}`,color:"negative"}),this.$emit("log",{level:"error",message:`CLI: Failed to join room ${this.roomName}: ${e.error.toString()}`})):(this.$emit("log",{level:"info",message:`CLI: Hosting room ${this.roomName}`}),this.clientsPollingInterval=setInterval((()=>{this.socket.emit("pollClients",this.roomName,(e=>{e.clientsCount&&(this.clientsCount=e.clientsCount-1)}))}),3e3))}))})),this.socket.on("dm",((e,t)=>{"string"===typeof t&&this.flags.allowPeerInput&&this.write(t)})),this.socket.on("disconnect",(()=>{this.$emit("showNotif",{message:"Disconnected from cli server"}),this.$emit("log",{level:"warn",message:"CLI: Disconnected from cli server"}),!1!==this.flags.serverActive&&this.stopServer()})),this.flags.serverToggling=!1,this.flags.serverActive=!0},stopServer(){this.flags.serverToggling=!0,this.socket.disconnect(),clearInterval(this.clientsPollingInterval),this.clientsCount=0,this.roomName="",this.flags.serverToggling=!1,this.flags.serverActive=!1,this.flags.sharePopup=!1},broadcast(e){this.socket.emit("broadcast",this.roomName,e,(e=>{e.error&&(this.$emit("log",{level:"error",message:`Remote CLI: Failed to broadcast: ${e.error.toString()}`}),console.error(e.message))}))},async start(){this.flags.rpcActive=this.rpcActive,this.rpcActive&&await this.stopRpc(),setTimeout(this.init,500);let e=!1,t=0,s=[];this.unbind=this.flipper.emitter.on("cli output",(i=>{if(1===i.byteLength){const o=i[0];if(e||o>>7!==1)t>0&&o>>6===2?(s.push(o),t--,0===t?(i=new Uint8Array(s),e=!1,s=[]):i=void 0):(e=!1,t=0,s=[]);else{e=!0,i=void 0,s.push(o);for(let e=6;e>=4;e--){if((o>>e)%2!==1)break;t++}}}if(i){const e=(new TextDecoder).decode(i).replaceAll("","");this.terminal.write(e),this.flags.serverActive&&this.broadcast(e)}}))}},mounted(){this.connected&&setTimeout(this.start,500),"true"===new URLSearchParams(location.search).get("sharing")&&(this.flags.sharingEnabled=!0)},async beforeUnmount(){this.unbind(),this.flags.serverActive&&this.stopServer()}});var b=s(1639),C=s(9885),y=s(3940),A=s(4455),q=s(990),S=s(2074),_=s(4458),$=s(3190),I=s(136),N=s(3175),P=s(1821),T=s(2146),Z=s(9984),x=s.n(Z);const Q=(0,b.Z)(k,[["render",d]]),W=Q;x()(k,"components",{QPage:C.Z,QSpinner:y.Z,QBtn:A.Z,QBadge:q.Z,QDialog:S.Z,QCard:_.Z,QCardSection:$.Z,QSpace:I.Z,QToggle:N.Z,QCardActions:P.Z}),x()(k,"directives",{ClosePopup:T.Z})}}]);