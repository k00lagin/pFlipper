"use strict";(self["webpackChunkmy_flipper_net"]=self["webpackChunkmy_flipper_net"]||[]).push([[638],{8143:(e,t,a)=>{a.r(t),a.d(t,{default:()=>A});a(702);var i=a(9835),s=a(6970);const l=e=>((0,i.dD)("data-v-6eb9b6dc"),e=e(),(0,i.Cn)(),e),n={key:0,class:"column flex-center q-my-xl"},o=l((()=>(0,i._)("p",null,"Waiting for Flipper...",-1))),r={key:1,id:"paint-wrapper",class:"fit flex justify-center items-center bg-white"},c={class:"flex column full-width items-center"},m={class:"flex column q-mb-md"},h={class:"flex flex-center q-ma-sm"},p=(0,i.Uk)("Send frame"),d={class:"hidden",width:"128",height:"64",ref:"resizeCanvas"};function g(e,t,a,l,g,u){const f=(0,i.up)("q-spinner"),v=(0,i.up)("q-toggle"),w=(0,i.up)("q-btn"),S=(0,i.up)("q-input"),b=(0,i.up)("q-btn-group"),x=(0,i.up)("q-icon"),y=(0,i.up)("q-btn-toggle"),k=(0,i.up)("q-item-section"),C=(0,i.up)("q-slider"),I=(0,i.up)("q-checkbox"),_=(0,i.up)("q-item"),q=(0,i.up)("q-page");return(0,i.wg)(),(0,i.j4)(q,{class:"column items-center q-pa-md"},{default:(0,i.w5)((()=>[e.connected&&e.flags.rpcActive&&!e.flags.rpcToggling?(0,i.kq)("",!0):((0,i.wg)(),(0,i.iD)("div",n,[(0,i.Wm)(f,{color:"primary",size:"3em",class:"q-mb-md"}),o])),e.connected&&e.flags.rpcActive?((0,i.wg)(),(0,i.iD)("div",r,[(0,i._)("div",c,[(0,i._)("div",m,[(0,i._)("div",h,[(0,i.Wm)(v,{modelValue:e.autoStreaming.enabled,"onUpdate:modelValue":t[0]||(t[0]=t=>e.autoStreaming.enabled=t),label:"Auto-streaming",class:"q-mr-md",onClick:e.toggleAutoStreaming},null,8,["modelValue","onClick"]),e.autoStreaming.enabled?((0,i.wg)(),(0,i.j4)(S,{key:1,modelValue:e.autoStreaming.delay,"onUpdate:modelValue":t[1]||(t[1]=t=>e.autoStreaming.delay=t),label:"Delay, ms",dense:"",class:"inline-block",style:{width:"50px"}},null,8,["modelValue"])):((0,i.wg)(),(0,i.j4)(w,{key:0,onClick:e.sendFrame},{default:(0,i.w5)((()=>[p])),_:1},8,["onClick"]))]),(0,i._)("div",null,[(0,i._)("input",{type:"file",id:"file-upload",onChange:t[2]||(t[2]=(...t)=>e.upload&&e.upload(...t)),class:"hidden"},null,32),(0,i.Wm)(w,{onClick:e.triggerUpload,icon:"mdi-file-image-outline"},null,8,["onClick"]),(0,i.Wm)(b,{class:"q-ma-sm"},{default:(0,i.w5)((()=>[(0,i.Wm)(w,{disabled:this.saveState.length<2,icon:"undo",onClick:e.undo},null,8,["disabled","onClick"]),(0,i.Wm)(w,{disabled:0===this.restoreState.length,icon:"redo",onClick:e.redo},null,8,["disabled","onClick"]),(0,i.Wm)(w,{icon:"delete_outline",onClick:e.clear},null,8,["onClick"])])),_:1}),(0,i.Wm)(y,{modelValue:e.tool,"onUpdate:modelValue":t[3]||(t[3]=t=>e.tool=t),onClick:e.toggleTool,"toggle-color":"primary",options:[{value:"pencil",slot:"pencil"},{value:"eraser",slot:"eraser"}]},{pencil:(0,i.w5)((()=>[(0,i.Wm)(x,{name:"edit"})])),eraser:(0,i.w5)((()=>[(0,i.Wm)(x,{name:"mdi-eraser"})])),_:1},8,["modelValue","onClick"]),(0,i.Wm)(y,{modelValue:e.scaling,"onUpdate:modelValue":t[4]||(t[4]=t=>e.scaling=t),"toggle-color":"primary",options:[{label:"1x",value:1},{label:"2x",value:2},{label:"4x",value:4}],class:"q-ma-sm"},null,8,["modelValue"])]),(0,i._)("div",null,[(0,i.Wm)(_,null,{default:(0,i.w5)((()=>[(0,i.Wm)(k,{side:""},{default:(0,i.w5)((()=>[(0,i.Wm)(x,{name:"mdi-pencil-minus"})])),_:1}),(0,i.Wm)(k,null,{default:(0,i.w5)((()=>[(0,i.Wm)(C,{modelValue:e.ctx.lineWidth,"onUpdate:modelValue":t[5]||(t[5]=t=>e.ctx.lineWidth=t),min:1,max:10,step:1,label:"","label-always":"",class:"q-mt-lg"},null,8,["modelValue"])])),_:1}),(0,i.Wm)(k,{side:""},{default:(0,i.w5)((()=>[(0,i.Wm)(x,{name:"mdi-pencil-plus"})])),_:1}),(0,i.Wm)(I,{modelValue:e.flags.pixelGrid,"onUpdate:modelValue":t[6]||(t[6]=t=>e.flags.pixelGrid=t),class:"q-ml-md",label:"Pixel grid"},null,8,["modelValue"])])),_:1})])]),(0,i._)("div",{class:"canvas-container",style:(0,s.j5)("transform: scale("+e.scaling+"); top:"+64*(e.scaling-1)+"px;")},[e.flags.pixelGrid?((0,i.wg)(),(0,i.iD)("div",{key:0,class:"pixel-grid",onMousedown:t[7]||(t[7]=(...t)=>e.mouseDown&&e.mouseDown(...t)),onMouseup:t[8]||(t[8]=(...t)=>e.mouseUp&&e.mouseUp(...t)),onMousemove:t[9]||(t[9]=(...t)=>e.mouseMove&&e.mouseMove(...t))},null,32)):(0,i.kq)("",!0),(0,i._)("canvas",{width:"256",height:"128",ref:"mainCanvas",onMousedown:t[10]||(t[10]=(...t)=>e.mouseDown&&e.mouseDown(...t)),onMouseup:t[11]||(t[11]=(...t)=>e.mouseUp&&e.mouseUp(...t)),onMousemove:t[12]||(t[12]=(...t)=>e.mouseMove&&e.mouseMove(...t))},null,544)],4)]),(0,i._)("canvas",d,null,512)])):(0,i.kq)("",!0)])),_:1})}a(6822),a(8170),a(5231),a(9359),a(6408);var u=a(499),f=a(5186);const v={0:[],1:[0],2:[1],3:[0,1],4:[2],5:[0,2],6:[1,2],7:[0,1,2],8:[3],9:[0,3],10:[1,3],11:[0,1,3],12:[2,3],13:[0,2,3],14:[1,2,3],15:[0,1,2,3],16:[4],17:[0,4],18:[1,4],19:[0,1,4],20:[2,4],21:[0,2,4],22:[1,2,4],23:[0,1,2,4],24:[3,4],25:[0,3,4],26:[1,3,4],27:[0,1,3,4],28:[2,3,4],29:[0,2,3,4],30:[1,2,3,4],31:[0,1,2,3,4],32:[5],33:[0,5],34:[1,5],35:[0,1,5],36:[2,5],37:[0,2,5],38:[1,2,5],39:[0,1,2,5],40:[3,5],41:[0,3,5],42:[1,3,5],43:[0,1,3,5],44:[2,3,5],45:[0,2,3,5],46:[1,2,3,5],47:[0,1,2,3,5],48:[4,5],49:[0,4,5],50:[1,4,5],51:[0,1,4,5],52:[2,4,5],53:[0,2,4,5],54:[1,2,4,5],55:[0,1,2,4,5],56:[3,4,5],57:[0,3,4,5],58:[1,3,4,5],59:[0,1,3,4,5],60:[2,3,4,5],61:[0,2,3,4,5],62:[1,2,3,4,5],63:[0,1,2,3,4,5],64:[6],65:[0,6],66:[1,6],67:[0,1,6],68:[2,6],69:[0,2,6],70:[1,2,6],71:[0,1,2,6],72:[3,6],73:[0,3,6],74:[1,3,6],75:[0,1,3,6],76:[2,3,6],77:[0,2,3,6],78:[1,2,3,6],79:[0,1,2,3,6],80:[4,6],81:[0,4,6],82:[1,4,6],83:[0,1,4,6],84:[2,4,6],85:[0,2,4,6],86:[1,2,4,6],87:[0,1,2,4,6],88:[3,4,6],89:[0,3,4,6],90:[1,3,4,6],91:[0,1,3,4,6],92:[2,3,4,6],93:[0,2,3,4,6],94:[1,2,3,4,6],95:[0,1,2,3,4,6],96:[5,6],97:[0,5,6],98:[1,5,6],99:[0,1,5,6],100:[2,5,6],101:[0,2,5,6],102:[1,2,5,6],103:[0,1,2,5,6],104:[3,5,6],105:[0,3,5,6],106:[1,3,5,6],107:[0,1,3,5,6],108:[2,3,5,6],109:[0,2,3,5,6],110:[1,2,3,5,6],111:[0,1,2,3,5,6],112:[4,5,6],113:[0,4,5,6],114:[1,4,5,6],115:[0,1,4,5,6],116:[2,4,5,6],117:[0,2,4,5,6],118:[1,2,4,5,6],119:[0,1,2,4,5,6],120:[3,4,5,6],121:[0,3,4,5,6],122:[1,3,4,5,6],123:[0,1,3,4,5,6],124:[2,3,4,5,6],125:[0,2,3,4,5,6],126:[1,2,3,4,5,6],127:[0,1,2,3,4,5,6],128:[7],129:[0,7],130:[1,7],131:[0,1,7],132:[2,7],133:[0,2,7],134:[1,2,7],135:[0,1,2,7],136:[3,7],137:[0,3,7],138:[1,3,7],139:[0,1,3,7],140:[2,3,7],141:[0,2,3,7],142:[1,2,3,7],143:[0,1,2,3,7],144:[4,7],145:[0,4,7],146:[1,4,7],147:[0,1,4,7],148:[2,4,7],149:[0,2,4,7],150:[1,2,4,7],151:[0,1,2,4,7],152:[3,4,7],153:[0,3,4,7],154:[1,3,4,7],155:[0,1,3,4,7],156:[2,3,4,7],157:[0,2,3,4,7],158:[1,2,3,4,7],159:[0,1,2,3,4,7],160:[5,7],161:[0,5,7],162:[1,5,7],163:[0,1,5,7],164:[2,5,7],165:[0,2,5,7],166:[1,2,5,7],167:[0,1,2,5,7],168:[3,5,7],169:[0,3,5,7],170:[1,3,5,7],171:[0,1,3,5,7],172:[2,3,5,7],173:[0,2,3,5,7],174:[1,2,3,5,7],175:[0,1,2,3,5,7],176:[4,5,7],177:[0,4,5,7],178:[1,4,5,7],179:[0,1,4,5,7],180:[2,4,5,7],181:[0,2,4,5,7],182:[1,2,4,5,7],183:[0,1,2,4,5,7],184:[3,4,5,7],185:[0,3,4,5,7],186:[1,3,4,5,7],187:[0,1,3,4,5,7],188:[2,3,4,5,7],189:[0,2,3,4,5,7],190:[1,2,3,4,5,7],191:[0,1,2,3,4,5,7],192:[6,7],193:[0,6,7],194:[1,6,7],195:[0,1,6,7],196:[2,6,7],197:[0,2,6,7],198:[1,2,6,7],199:[0,1,2,6,7],200:[3,6,7],201:[0,3,6,7],202:[1,3,6,7],203:[0,1,3,6,7],204:[2,3,6,7],205:[0,2,3,6,7],206:[1,2,3,6,7],207:[0,1,2,3,6,7],208:[4,6,7],209:[0,4,6,7],210:[1,4,6,7],211:[0,1,4,6,7],212:[2,4,6,7],213:[0,2,4,6,7],214:[1,2,4,6,7],215:[0,1,2,4,6,7],216:[3,4,6,7],217:[0,3,4,6,7],218:[1,3,4,6,7],219:[0,1,3,4,6,7],220:[2,3,4,6,7],221:[0,2,3,4,6,7],222:[1,2,3,4,6,7],223:[0,1,2,3,4,6,7],224:[5,6,7],225:[0,5,6,7],226:[1,5,6,7],227:[0,1,5,6,7],228:[2,5,6,7],229:[0,2,5,6,7],230:[1,2,5,6,7],231:[0,1,2,5,6,7],232:[3,5,6,7],233:[0,3,5,6,7],234:[1,3,5,6,7],235:[0,1,3,5,6,7],236:[2,3,5,6,7],237:[0,2,3,5,6,7],238:[1,2,3,5,6,7],239:[0,1,2,3,5,6,7],240:[4,5,6,7],241:[0,4,5,6,7],242:[1,4,5,6,7],243:[0,1,4,5,6,7],244:[2,4,5,6,7],245:[0,2,4,5,6,7],246:[1,2,4,5,6,7],247:[0,1,2,4,5,6,7],248:[3,4,5,6,7],249:[0,3,4,5,6,7],250:[1,3,4,5,6,7],251:[0,1,3,4,5,6,7],252:[2,3,4,5,6,7],253:[0,2,3,4,5,6,7],254:[1,2,3,4,5,6,7],255:[0,1,2,3,4,5,6,7]},w=(0,i.aZ)({name:"Paint",props:{flipper:Object,connected:Boolean,rpcActive:Boolean,info:Object},setup(){return{flags:(0,u.iH)({restarting:!1,rpcActive:!1,rpcToggling:!1,painting:!1,pixelGrid:!1}),ctx:(0,u.iH)({lineWidth:1}),tool:(0,u.iH)("pencil"),saveState:(0,u.iH)([]),restoreState:(0,u.iH)([]),autoStreaming:(0,u.iH)({enabled:!1,interval:void 0,delay:500}),backlightInterval:(0,u.iH)(void 0),file:(0,u.iH)(void 0),scaling:(0,u.iH)(1)}},methods:{async startRpc(){this.flags.rpcToggling=!0;const e=await this.flipper.commands.startRpcSession(this.flipper);if(!e.resolved||e.error)throw this.$emit("showNotif",{message:"Unable to start RPC session. Reload the page or reconnect Flipper manually.",color:"negative",reloadBtn:!0}),this.$emit("log",{level:"error",message:"Device: Couldn't start rpc session"}),new Error("Couldn't start rpc session");this.flags.rpcActive=!0,this.flags.rpcToggling=!1,this.$emit("setRpcStatus",!0),this.$emit("log",{level:"info",message:"Paint: RPC started"})},async stopRpc(){this.flags.rpcToggling=!0,await this.flipper.commands.stopRpcSession(),this.flags.rpcActive=!1,this.flags.rpcToggling=!1,this.$emit("setRpcStatus",!1),this.$emit("log",{level:"info",message:"Paint: RPC stopped"})},async restartRpc(e){(this.connected&&this.flags.rpcActive&&!this.flags.restarting||e)&&(this.flags.restarting=!0,await this.flipper.closeReader(),await(0,f.Z)(300),await this.flipper.disconnect(),await(0,f.Z)(300),await this.flipper.connect(),await this.startRpc())},async startVirtualDisplay(){const e=await this.flipper.commands.gui.startVirtualDisplay().catch((e=>this.rpcErrorHandler(e,"gui.startVirtualDisplay")));e.resolved&&!e.error||(this.$emit("showNotif",{message:"Couldn't start virtual display session: "+e.error,color:"negative"}),this.$emit("log",{level:"error",message:"Paint: Couldn't start virtual display session: "+e.error})),await this.enableBacklight(),this.backlightInterval=setInterval(this.enableBacklight,15e3)},async stopSession(){await this.flipper.commands.gui.stopVirtualDisplay().catch((e=>this.rpcErrorHandler(e,"gui.stopVirtualDisplay")))},async sendFrame(){const e=this.resize(),t=this.filter("monochrome",e),a=t.data;let i=0,s=1;const l=[];for(let n=0;n<64;n++)for(let e=0;e<16;e++){const e=[];for(let t=0;t<8;t++){const l=!a[4*i];l&&e.push(t),i++;const n=i/(128*s)===1;if(n){s++;break}}for(let t=0;t<256;t++)JSON.stringify(v[String(t)])===JSON.stringify(e)&&l.push(t)}this.flipper.commands.gui.screenFrame(new Uint8Array(l)).catch((e=>this.rpcErrorHandler(e,"gui.screenFrame")))},toggleAutoStreaming(){this.autoStreaming.enabled?(this.autoStreaming.interval&&clearInterval(this.autoStreaming.interval),this.autoStreaming.interval=setInterval(this.sendFrame,this.autoStreaming.delay)):clearInterval(this.autoStreaming.interval)},async enableBacklight(){await this.flipper.commands.gui.sendInputEvent(4,0).catch((e=>this.rpcErrorHandler(e,"gui.sendInputEvent"))),await this.flipper.commands.gui.sendInputEvent(4,2).catch((e=>this.rpcErrorHandler(e,"gui.sendInputEvent"))),await this.flipper.commands.gui.sendInputEvent(4,1).catch((e=>this.rpcErrorHandler(e,"gui.sendInputEvent")))},clear(){this.save(),this.ctx.clearRect(0,0,this.$refs.mainCanvas.width,this.$refs.mainCanvas.height),this.ctx.fillRect(0,0,256,128)},save(){const e=this.filter("orange");this.ctx.putImageData(e,0,0),this.saveState.push(this.ctx.getImageData(0,0,256,128)),this.restoreState.length>0&&(this.restoreState=[]),30===this.saveState.length&&this.saveState.shift()},undo(){this.restoreState.push(this.saveState.pop()),30===this.restoreState.length&&this.restoreState.shift(),this.ctx.putImageData(this.saveState[this.saveState.length-1],0,0)},redo(){this.saveState.push(this.restoreState.pop()),30===this.saveState.length&&this.saveState.shift(),this.ctx.putImageData(this.saveState[this.saveState.length-1],0,0)},triggerUpload(){document.getElementById("file-upload").click()},upload(e){const t=e.target.files[0];if(t){const e=new FileReader;e.readAsDataURL(t);const a=new Image;e.onload=e=>{e.target.readyState===FileReader.DONE&&(a.onload=()=>{this.ctx.drawImage(a,0,0,256,128),this.save()},a.src=e.target.result)}}},mouseDown(e){this.flags.painting=!0,this.ctx.beginPath()},mouseUp(e){this.stroke(e),this.flags.painting=!1,this.save()},mouseMove(e){this.flags.painting&&(this.stroke(e),this.ctx.beginPath(),this.ctx.moveTo(e.offsetX+e.offsetX%2-1,e.offsetY+e.offsetY%2-1))},stroke(e){this.ctx.lineTo(e.offsetX+e.offsetX%2-1,e.offsetY+e.offsetY%2-1),this.ctx.stroke()},filter(e,t){t||(t=this.ctx.getImageData(0,0,256,128));const a=t.data,i=t.width*t.height;for(let s=0;s<i;s++){const t=a[4*s],i=a[4*s+1],l=a[4*s+2],n=a[4*s+3];if(n){const n=(t+i+l)/3;n<=128?(a[4*s]=0,a[4*s+1]=0,a[4*s+2]=0):"orange"===e?(a[4*s]=254,a[4*s+1]=138,a[4*s+2]=44):"monochrome"===e&&(a[4*s]=255,a[4*s+1]=255,a[4*s+2]=255)}else a[4*s]=255,a[4*s+1]=255,a[4*s+2]=255,a[4*s+3]=1}return t},resize(){const e=this.$refs.resizeCanvas.getContext("2d");e.scale(.5,.5),e.drawImage(this.$refs.mainCanvas,0,0);const t=e.getImageData(0,0,128,64);return e.scale(2,2),e.fillStyle="#ffff",e.fillRect(0,0,128,64),t},toggleTool(){this.ctx.strokeStyle="pencil"===this.tool?"black":"#fe8a2c"},rpcErrorHandler(e,t){e=e.toString(),this.$emit("showNotif",{message:`RPC error in command '${t}': ${e}`,color:"negative"}),this.$emit("log",{level:"error",message:`Paint: RPC error in command '${t}': ${e}`})},async start(){this.flags.rpcActive=this.rpcActive,this.rpcActive||(setTimeout((()=>{if(!this.rpcActive)return this.restartRpc(!0)}),1e3),await this.startRpc())}},async mounted(){this.connected&&null!==this.info&&this.info.storage_databases_present&&await this.start(),this.startVirtualDisplay(),this.ctx=this.$refs.mainCanvas.getContext("2d"),this.ctx.lineWidth=1,this.ctx.lineCap="square",this.ctx.strokeStyle="black",this.ctx.imageSmoothingEnabled=!1,this.ctx.globalCompositeOperation="new content",this.ctx.fillStyle="#fe8a2c",this.ctx.fillRect(0,0,256,128),this.save()},beforeUnmount(){this.autoStreaming.interval&&clearInterval(this.autoStreaming.interval),clearInterval(this.backlightInterval),this.stopSession()}});var S=a(1639),b=a(9885),x=a(3940),y=a(3175),k=a(4455),C=a(3119),I=a(7236),_=a(1389),q=a(2857),D=a(490),R=a(1233),V=a(8423),W=a(1221),$=a(9984),U=a.n($);const E=(0,S.Z)(w,[["render",g],["__scopeId","data-v-6eb9b6dc"]]),A=E;U()(w,"components",{QPage:b.Z,QSpinner:x.Z,QToggle:y.Z,QBtn:k.Z,QInput:C.Z,QBtnGroup:I.Z,QBtnToggle:_.Z,QIcon:q.Z,QItem:D.Z,QItemSection:R.Z,QSlider:V.Z,QCheckbox:W.Z})}}]);